#
# Test --log-slow-extra
#

-- source include/have_innodb.inc

--let $file_format_save = `SELECT @@innodb_file_format`

#
# Confirm that per-query stats work.
#

set global long_query_time=0;

--disable_warnings
--disable_query_log

drop table if exists big_table_slow;
create table big_table_slow (id int primary key auto_increment, v varchar(200), t text) engine=innodb key_block_size=8;

let $x = 20000;
while ($x)
{
eval insert into big_table_slow values(2 * $x, lpad("v", $x, "b"), lpad("a", ($x * 100) mod 9000, "b"));
dec $x;
}

--enable_query_log
--enable_warnings

connect (con,localhost,root,,);

select count(*) from big_table_slow;

connect (con1,localhost,root,,);

select count(*) from big_table_slow;

select count(*) from big_table_slow where id>1000 and id<2000;

select * from big_table_slow where id=2;

select count(*) from big_table_slow where id >10000;

select count(*) from big_table_slow where id < 100000;

--echo # Cleanup

connection default;
set global long_query_time=1;
disconnect con1;
let $count_sessions= 2;
--source include/wait_until_count_sessions.inc
disconnect con;
drop table big_table_slow;

eval SET GLOBAL innodb_file_format = \"$file_format_save\";

--echo #
--echo # This is a hack to check the log result.
--echo # We strip off time related fields (non-deterministic) ana verify the rest are correct.
--echo #

--perl
open FILE, "$ENV{'MYSQLTEST_VARDIR'}/mysqld.1/mysqld-slow.log" or die;
my @lines = <FILE>;
foreach $line (@lines) {
  if ($line =~ m/^# Query_time/) {
    $line =~ m/(Rows_sent.*) Start.*/;
    print "$1\n";
  }
}
EOF

--exit
