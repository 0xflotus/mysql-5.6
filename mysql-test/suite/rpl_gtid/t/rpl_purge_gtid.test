source include/master-slave.inc;
source include/gtid_utils.inc;

# FB/herman T57424648 - This is a temporary workaround to allow this test to pass.
# The functionality is currently broken, as can be seen by show master status returning gtids that have been purged.
# The is warning suppression should be removed after the feature is fixed and the test re-recorded.
--disable_query_log
set sql_log_bin=0;
CALL mtr.add_suppression("The transaction owned GTID is already in the gtid_executed table");
set sql_log_bin=1;
connection slave;
set sql_log_bin=0;
CALL mtr.add_suppression("The transaction owned GTID is already in the gtid_executed table");
set sql_log_bin=1;
--enable_query_log

connection master;
# purge gtid succeeds even if the given uuid is not present in the gtid set.
purge gtid 'ffffab6a-d12b-11e5-a3ea-0002c9d31542';

let $master_uuid= `select @@server_uuid`;
create table t1 (a int);
insert into t1 values(1);
insert into t1 values(1);
insert into t1 values(1);
insert into t1 values(1);

set gtid_next = 'ffffab6a-d12b-11e5-a3ea-0002c9d31542:1';
insert into t1 values(1);
set gtid_next = 'ffffab6a-d12b-11e5-a3ea-0002c9d31542:2';
insert into t1 values(1);
set gtid_next = 'ffffab6a-d12b-11e5-a3ea-0002c9d31543:1';
insert into t1 values(1);
set gtid_next = AUTOMATIC;

error ER_INVALID_UUID;
purge gtid 'garbage uuid';

error ER_INVALID_UUID;
purge gtid 'ffffab6a-d12b-11e5-a3ea-0002c9d31542 ,  , ffffab6a-d12b-11e5-a3ea-0002c9d31543';

error ER_INVALID_UUID;
purge gtid ' , ';

error ER_INVALID_UUID;
purge gtid ',';

error ER_INVALID_UUID;
purge gtid '';

replace_result $master_uuid master_uuid;
error ER_CANNOT_PURGE_SERVER_UUID;
eval purge gtid '$master_uuid';

let $value = `select @@global.gtid_executed`;
# gtid_executed is not sorted. So we need this to avoid test failures.
replace_result $value gtid_executed_set;
eval select gtid_intersection_with_uuid('$value', 'ffffab6a-d12b-11e5-a3ea-0002c9d31542');
replace_result $value gtid_executed_set;
eval select gtid_intersection_with_uuid('$value', 'ffffab6a-d12b-11e5-a3ea-0002c9d31543');
replace_result $value gtid_executed_set $master_uuid master_uuid;
eval select gtid_intersection_with_uuid('$value', '$master_uuid');

echo Check 'purge gtid' query resets logged and lost gtid state.;
purge gtid 'ffffab6a-d12b-11e5-a3ea-0002c9d31542 , ffffab6a-d12b-11e5-a3ea-0002c9d31543';
insert into t1 values(1);
insert into t1 values(1);

replace_result $master_uuid master_uuid;
select @@global.gtid_executed;

--source include/sync_slave_sql_with_master.inc
echo Check gtid_executed on slave is also reset;
replace_result $master_uuid master_uuid;
select @@global.gtid_executed;

replace_result $master_uuid master_uuid;
error ER_CANNOT_PURGE_SERVER_UUID;
eval purge gtid '$master_uuid';

connection master;
drop table t1;

source include/gtid_utils_end.inc;
source include/rpl_end.inc;
