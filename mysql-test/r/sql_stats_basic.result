create user user_super@localhost identified by 'su';
grant all on *.* to user_super@localhost with grant option;
Case 1: sql_stats_control=OFF_HARD
select @@sql_stats_control;
@@sql_stats_control
OFF_HARD
select 42;
42
42
select sql_id, plan_id, table_schema, user_name, execution_count
from information_schema.sql_statistics;
sql_id	plan_id	table_schema	user_name	execution_count
Case 2: sql_stats_control=ON
set @@GLOBAL.sql_stats_control="ON";
select @@sql_stats_control;
@@sql_stats_control
ON
set @@GLOBAL.sql_plans_control=ON;
select @@sql_plans_control;
@@sql_plans_control
ON
select 1;
1
1
select 2;
2
2
select 100;
100
100
select sql_id, plan_id, table_schema, user_name, execution_count
from information_schema.sql_statistics order by sql_id;
sql_id	plan_id	table_schema	user_name	execution_count
08218f46736de8bfbd53566c8c48cc12	NULL	test	user_super	1
159d8280d1e0ee77a1aadb0152e02fd4	NULL	test	user_super	1
7607b20afdca65f50cf919609d171ad8	NULL	test	user_super	1
ea1a18bec5a37513f7a0720e73526477	NULL	test	user_super	3
create table t1(c int);
insert into t1 values(1);
insert into t1 values(2);
insert into t1 values(3);
insert into t1 values(4);
insert into t1 values(5);
update t1 set c=c+100;
update t1 set c=c+300;
update t1 set c=c+500;
delete from t1 where c=905;
delete from t1 where c=903;
select sql_id, plan_id, table_schema, user_name, execution_count,
rows_inserted, rows_updated, rows_deleted, rows_read
from information_schema.sql_statistics
order by sql_id;
sql_id	plan_id	table_schema	user_name	execution_count	rows_inserted	rows_updated	rows_deleted	rows_read
08218f46736de8bfbd53566c8c48cc12	NULL	test	user_super	1	0	0	0	0
159d8280d1e0ee77a1aadb0152e02fd4	NULL	test	user_super	1	0	0	0	0
279bcd77d61df560ddc2ce0524b09da4	c63aca0e3e2270468eaadb4364351527	test	user_super	5	5	0	0	0
3da33426ba270d36ad95b2b819d03a24	0863aa843e03198bcd1fb35e2ba33940	test	user_super	2	0	0	2	9
7607b20afdca65f50cf919609d171ad8	NULL	test	user_super	1	0	0	0	0
b2c751001aacadcf66d589277fe89c39	7d1ccceff3a45eea46dbad6208f7f52e	test	user_super	3	0	15	0	15
b473dac11510107b3dd116f54e106008	NULL	test	user_super	1	0	0	0	0
bcb18f202af627f545e12f03303093b0	d8a6538dcb5999060d6f545dfb9ce16d	test	user_super	1	0	0	0	0
ea1a18bec5a37513f7a0720e73526477	NULL	test	user_super	3	0	0	0	0
select information_schema.sql_statistics.sql_id, table_schema, user_name,
execution_count, sql_text
from information_schema.sql_statistics, information_schema.sql_text
where information_schema.sql_statistics.sql_id=information_schema.sql_text.sql_id
order by sql_id;
sql_id	table_schema	user_name	execution_count	sql_text
08218f46736de8bfbd53566c8c48cc12	test	user_super	1	SET @@GLOBAL . `sql_plans_control` = ON 
159d8280d1e0ee77a1aadb0152e02fd4	test	user_super	1	SELECT @@`sql_plans_control` 
279bcd77d61df560ddc2ce0524b09da4	test	user_super	5	INSERT INTO `t1` VALUES (?) 
3da33426ba270d36ad95b2b819d03a24	test	user_super	2	DELETE FROM `t1` WHERE `c` = ? 
4dbe914e82a9f71f7ecd7e0829306d3e	test	user_super	1	SELECT `sql_id` , `plan_id` , `table_schema` , `user_name` , `execution_count` , `rows_inserted` , `rows_updated` , `rows_deleted` , `rows_read` FROM `information_schema` . `sql_statistics` ORDER BY `sql_id` 
7607b20afdca65f50cf919609d171ad8	test	user_super	1	SELECT @@`sql_stats_control` 
b2c751001aacadcf66d589277fe89c39	test	user_super	3	UPDATE `t1` SET `c` = `c` + ? 
b473dac11510107b3dd116f54e106008	test	user_super	1	CREATE TABLE `t1` ( `c` INTEGER ) 
bcb18f202af627f545e12f03303093b0	test	user_super	1	SELECT `sql_id` , `plan_id` , `table_schema` , `user_name` , `execution_count` FROM `information_schema` . `sql_statistics` ORDER BY `sql_id` 
ea1a18bec5a37513f7a0720e73526477	test	user_super	3	SELECT ? 
Case 3: sql_stats_control=OFF_SOFT. Disable collection, but keep the data around.
set @@GLOBAL.sql_stats_control="OFF_SOFT";
select @@sql_stats_control;
@@sql_stats_control
OFF_SOFT
select 1 union select 2;
1
1
2
select 1 union select 2 union select 3;
1
1
2
3
select sql_id, plan_id, table_schema, user_name, execution_count,
rows_inserted, rows_updated, rows_deleted, rows_read
from information_schema.sql_statistics
order by sql_id;
sql_id	plan_id	table_schema	user_name	execution_count	rows_inserted	rows_updated	rows_deleted	rows_read
08218f46736de8bfbd53566c8c48cc12	NULL	test	user_super	1	0	0	0	0
159d8280d1e0ee77a1aadb0152e02fd4	NULL	test	user_super	1	0	0	0	0
279bcd77d61df560ddc2ce0524b09da4	c63aca0e3e2270468eaadb4364351527	test	user_super	5	5	0	0	0
3da33426ba270d36ad95b2b819d03a24	0863aa843e03198bcd1fb35e2ba33940	test	user_super	2	0	0	2	9
4dbe914e82a9f71f7ecd7e0829306d3e	d8a6538dcb5999060d6f545dfb9ce16d	test	user_super	1	0	0	0	0
7607b20afdca65f50cf919609d171ad8	NULL	test	user_super	1	0	0	0	0
b2c751001aacadcf66d589277fe89c39	7d1ccceff3a45eea46dbad6208f7f52e	test	user_super	3	0	15	0	15
b473dac11510107b3dd116f54e106008	NULL	test	user_super	1	0	0	0	0
bcb18f202af627f545e12f03303093b0	d8a6538dcb5999060d6f545dfb9ce16d	test	user_super	1	0	0	0	0
c0cc565ac4469288962d2e15f96722c0	2eea1bb868964e5a66a4f786e40cfbf3	test	user_super	1	0	0	0	0
ea1a18bec5a37513f7a0720e73526477	NULL	test	user_super	3	0	0	0	0
Case 4: sql_stats_control=OFF_HARD. Disable, and check if all data is deleted.
set @@GLOBAL.sql_stats_control="OFF_HARD";
select @@sql_stats_control;
@@sql_stats_control
OFF_HARD
select sql_id, plan_id, table_schema, user_name, execution_count,
rows_inserted, rows_updated, rows_deleted, rows_read
from information_schema.sql_statistics
order by sql_id;
sql_id	plan_id	table_schema	user_name	execution_count	rows_inserted	rows_updated	rows_deleted	rows_read
Case 5: sql_stats_control=ON. Re-enable to make sure that data is making its way to sql_statistics.
set @@GLOBAL.sql_stats_control="ON";
select @@sql_stats_control;
@@sql_stats_control
ON
select 101;
101
101
select sql_id, plan_id, table_schema, user_name, execution_count,
rows_inserted, rows_updated, rows_deleted, rows_read
from information_schema.sql_statistics
order by sql_id;
sql_id	plan_id	table_schema	user_name	execution_count	rows_inserted	rows_updated	rows_deleted	rows_read
7607b20afdca65f50cf919609d171ad8	NULL	test	user_super	1	0	0	0	0
ea1a18bec5a37513f7a0720e73526477	NULL	test	user_super	1	0	0	0	0
Case 6: Multi-query support
set @@GLOBAL.sql_stats_control="OFF_HARD";
set @@GLOBAL.sql_stats_control="ON";
select @@sql_stats_control;
@@sql_stats_control
ON
select 1;
select 2;
select 3;
create table t2(c int);
insert into t2 values(100);
select * from t2;
update t2 set c=c+7;
delete from t2 where c=107;
drop table t2;
||||
1
1
2
2
3
3
c
100
select sql_id, plan_id, table_schema, user_name, execution_count,
rows_inserted, rows_updated, rows_deleted, rows_read
from information_schema.sql_statistics
order by sql_id||||
sql_id	plan_id	table_schema	user_name	execution_count	rows_inserted	rows_updated	rows_deleted	rows_read
1a15305517598063a249eb3eaac3044f	c63aca0e3e2270468eaadb4364351527	test	user_super	1	1	0	0	0
30db1722a6d958b0de756ec322a0ac6b	f343b9befca0a2e2d56935211139703e	test	user_super	1	0	0	1	1
41e549ce8a53912cafa487f3aace1e94	5b09041e2c03efb8b820a1fda0bf8146	test	user_super	1	0	0	0	2
7607b20afdca65f50cf919609d171ad8	NULL	test	user_super	1	0	0	0	0
a78554303c31babf6aaaaf2193428953	NULL	test	user_super	1	0	0	0	0
b551871920521a753f36a52ad702c054	3735d0563cc8e7df82f25be86d592dc1	test	user_super	1	0	1	0	1
e5672050f068011f4e794f8aa32262bd	NULL	test	user_super	1	0	0	0	0
ea1a18bec5a37513f7a0720e73526477	NULL	test	user_super	3	0	0	0	0
Case 7: Query no sampling by default
set @@GLOBAL.sql_stats_control="OFF_HARD";
set @@GLOBAL.sql_stats_control="ON";
select @@sql_stats_control;
@@sql_stats_control
ON
select 1;
1
1
select 3;
3
3
select 4;
4
4
select sql_id, plan_id, table_schema, user_name, query_sample_text,
query_sample_seen, execution_count, rows_inserted, rows_updated,
rows_deleted, rows_read
from information_schema.sql_statistics
order by sql_id;
sql_id	plan_id	table_schema	user_name	query_sample_text	query_sample_seen	execution_count	rows_inserted	rows_updated	rows_deleted	rows_read
7607b20afdca65f50cf919609d171ad8	NULL	test	user_super		NULL	1	0	0	0	0
ea1a18bec5a37513f7a0720e73526477	NULL	test	user_super		NULL	3	0	0	0	0
Case 8: Query Only Once Sampling support
set @@GLOBAL.sql_stats_control="OFF_HARD";
set @@GLOBAL.sql_stats_control="ON";
set @@GLOBAL.max_digest_sample_age=0;
select @@sql_stats_control;
@@sql_stats_control
ON
select @@max_digest_sample_age;
@@max_digest_sample_age
0
select 1;
1
1
select 3;
3
3
select 4;
4
4
select sql_id, plan_id, table_schema, user_name, query_sample_text,
(query_sample_seen > 0) as is_query_sample_seen_valid, execution_count,
rows_inserted, rows_updated, rows_deleted, rows_read
from information_schema.sql_statistics
order by sql_id;
sql_id	plan_id	table_schema	user_name	query_sample_text	is_query_sample_seen_valid	execution_count	rows_inserted	rows_updated	rows_deleted	rows_read
7607b20afdca65f50cf919609d171ad8	NULL	test	user_super	select @@sql_stats_control	1	1	0	0	0	0
e9e49af74e44eb320d7ede94b70e0ffa	NULL	test	user_super	set @@GLOBAL.max_digest_sample_age=0	1	1	0	0	0	0
ea1a18bec5a37513f7a0720e73526477	NULL	test	user_super	select 1	1	3	0	0	0	0
f1c369a57edbf1642f8cfcf4adbe5ab2	NULL	test	user_super	select @@max_digest_sample_age	1	1	0	0	0	0
Case 9: Query Re-sampling support
set @@GLOBAL.sql_stats_control="OFF_HARD";
set @@GLOBAL.sql_stats_control="ON";
set @@GLOBAL.max_digest_sample_age=1;
select @@sql_stats_control;
@@sql_stats_control
ON
select @@max_digest_sample_age;
@@max_digest_sample_age
1
select 1;
1
1
select sleep(2);
sleep(2)
0
select 3;
3
3
select 4;
4
4
select sql_id, plan_id, table_schema, user_name, query_sample_text,
(query_sample_seen > 0 && CURRENT_TIMESTAMP - query_sample_seen < 10)
as is_query_sample_seen_valid, execution_count, rows_inserted,
rows_updated, rows_deleted, rows_read
from information_schema.sql_statistics
order by sql_id;
sql_id	plan_id	table_schema	user_name	query_sample_text	is_query_sample_seen_valid	execution_count	rows_inserted	rows_updated	rows_deleted	rows_read
7607b20afdca65f50cf919609d171ad8	NULL	test	user_super	select @@sql_stats_control	1	1	0	0	0	0
e9e49af74e44eb320d7ede94b70e0ffa	NULL	test	user_super	set @@GLOBAL.max_digest_sample_age=1	1	1	0	0	0	0
ea1a18bec5a37513f7a0720e73526477	NULL	test	user_super	select 3	1	3	0	0	0	0
f1c369a57edbf1642f8cfcf4adbe5ab2	NULL	test	user_super	select @@max_digest_sample_age	1	1	0	0	0	0
fdfef25fbf8f8595a008663beb4d5727	NULL	test	user_super	select sleep(2)	1	1	0	0	0	0
Cleanup
set @@GLOBAL.sql_stats_control="OFF_HARD";
set @@GLOBAL.sql_plans_control=OFF_HARD;
set @@GLOBAL.max_digest_sample_age=-1;
drop table t1;
drop user user_super@localhost;
